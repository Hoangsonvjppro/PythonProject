{% extends "base.html" %}

{% block title %}Translate Text{% endblock %}

{% block content %}
    <div class="container">
        <h2 class="text-center">Translate Text</h2>
        <form id="translate-form" class="mt-3">
            <div class="mb-3">
                <label for="text" class="form-label">Enter text or speak:</label>
                <textarea name="text" id="text" rows="3" class="form-control" required></textarea>
                <button type="button" id="startRecord" class="btn btn-success mt-2">üé§ Start Recording</button>
                <button type="button" id="stopRecord" class="btn btn-danger mt-2" style="display: none;">Stop Recording</button>
            </div>
            <div class="mb-3">
                <label for="target_lang" class="form-label">Target Language:</label>
                <select id="target_lang" class="form-select" name="target_lang">
                    <option value="en">English</option>
                    <option value="vi">Vietnamese</option>
                    <option value="cn">Chinese</option>
                    <option value="ja">Japanese</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Translate</button>
        </form>
        <h3 class="mt-3" id="translatedText"></h3>
    </div>

    <script>
        let recognition = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // Kh·ªüi t·∫°o Web Speech API
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; // Ch·ªâ ghi √¢m m·ªôt l·∫ßn
            recognition.lang = 'vi-VN'; // Ng√¥n ng·ªØ m·∫∑c ƒë·ªãnh l√† ti·∫øng Vi·ªát
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = function(event) {
                const speechResult = event.results[0][0].transcript;
                document.getElementById('text').value = speechResult;
                document.getElementById('stopRecord').style.display = 'none';
                document.getElementById('startRecord').style.display = 'inline-block';
            };

            recognition.onerror = function(event) {
                console.error('L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i:', event.error);
                document.getElementById('translatedText').innerText = 'L·ªói khi nh·∫≠n di·ªán gi·ªçng n√≥i!';
                document.getElementById('stopRecord').style.display = 'none';
                document.getElementById('startRecord').style.display = 'inline-block';
            };
        } else {
            alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i!');
        }

        // B·∫Øt ƒë·∫ßu ghi √¢m b·∫±ng Web Speech API
        document.getElementById('startRecord').addEventListener('click', function() {
            if (recognition) {
                recognition.start();
                document.getElementById('startRecord').style.display = 'none';
                document.getElementById('stopRecord').style.display = 'inline-block';
                document.getElementById('translatedText').innerText = 'ƒêang ghi √¢m...';
            }
        });

        // D·ª´ng ghi √¢m b·∫±ng Web Speech API
        document.getElementById('stopRecord').addEventListener('click', function() {
            if (recognition) {
                recognition.stop();
                document.getElementById('translatedText').innerText = '';
            }
        });

        // X·ª≠ l√Ω d·ªãch vƒÉn b·∫£n
        document.getElementById("translate-form").addEventListener("submit", async function(event) {
            event.preventDefault();

            let text = document.getElementById("text").value;
            let target_lang = document.getElementById("target_lang").value;

            try {
                let response = await fetch("/translate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ text: text, target_lang: target_lang })
                });

                let data = await response.json();

                if (data.success) {
                    document.getElementById("translatedText").innerText = "K·∫øt qu·∫£: " + data.translated_text;
                } else {
                    document.getElementById("translatedText").innerText = "L·ªói: " + data.error;
                }
            } catch (error) {
                console.error("L·ªói:", error);
                document.getElementById("translatedText").innerText = "L·ªói khi g·ª≠i request!";
            }
        });
    </script>
{% endblock %}