{% extends "base.html" %}

{% block title %}Chat Cộng Đồng{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>

<form class="chat-container" id="chat-container-community">
    <div class="chat-header">
        Chat Cộng Đồng
        <button id="toggle-ai-chat" class="switch-chat-button">Switch to AI Chat</button>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="message-input" placeholder="Type your message..." />
        <button id="send-button">Send</button>
    </div>
</form>

<form class="chat-container" id="chat-container-ai" style="display: none;">
    <div class="chat-header">
        Chat with A.I
        <button id="toggle-community-chat" class="switch-chat-button">Switch to Community Chat</button>
    </div>
    <div class="chat-messages" id="chat-messages-ai"></div>
    <div class="chat-input">
        <input type="text" id="message-input-ai" placeholder="Type your message..." />
        <button id="send-button-ai">Send</button>
    </div>
</form>

<script>
    const socket = io();
    const chatMessages = document.getElementById("chat-messages");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");
    const chatMessagesAI = document.getElementById("chat-messages-ai");
    const messageInputAI = document.getElementById("message-input-ai");
    const sendButtonAI = document.getElementById("send-button-ai");
    const chatContainerCommunity = document.getElementById("chat-container-community");
    const chatContainerAI = document.getElementById("chat-container-ai");
    const toggleCommunityChat = document.getElementById("toggle-community-chat");
    const toggleAIChat = document.getElementById("toggle-ai-chat");

    // Hàm chuyển đổi giữa khung chat cộng đồng và khung chat AI
    function switchChat(chatType) {
        if (chatType === "community") {
            chatContainerCommunity.style.display = "block";
            chatContainerAI.style.display = "none";
        } else {
            chatContainerCommunity.style.display = "none";
            chatContainerAI.style.display = "block";
        }
    }

    toggleCommunityChat.addEventListener("click", (e) => {
        e.preventDefault();
        switchChat("community");
    });

    toggleAIChat.addEventListener("click", (e) => {
        e.preventDefault();
        switchChat("ai");
    });

    sendButton.addEventListener("click", (event) => {
        event.preventDefault(); // Ngăn chặn reload trang
        const message = messageInput.value.trim();
        if (message) {
            socket.emit("send_message", { message }); // Gửi lên server
            messageInput.value = ""; // Xóa nội dung input sau khi gửi
        }
    });
    // Sự kiện nhấn Enter trong ô nhập tin nhắn cộng đồng
    messageInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault(); // Ngăn chặn xuống dòng
            sendButton.click(); // Gọi sự kiện click của nút gửi
        }
    });

    // Sự kiện nhấn Enter trong ô nhập tin nhắn AI
    messageInputAI.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendButtonAI.click();
        }
    });


    // Nhận tin nhắn từ server và hiển thị
    socket.on("new_message", (data) => {
        addMessageCommunity(data.username, data.message, data.avatar);
    });

    // Hàm thêm tin nhắn vào khung chat cộng đồng
    function addMessageCommunity(username, message, avatar) {
        const messageElement = document.createElement("div");
        messageElement.className = "message";

        // Kiểm tra nếu tin nhắn là của người dùng hiện tại
        const isSentMessage = username === "{{ current_user.username if current_user.is_authenticated else 'Guest' }}";
        if (isSentMessage) {
            messageElement.classList.add("sent"); // Nếu là tin nhắn của người dùng hiện tại, căn phải
        } else {
            messageElement.classList.add("received"); // Nếu là tin nhắn của người khác, căn trái
        }

        // Thêm avatar
        const avatarImg = document.createElement("img");
        avatarImg.src = avatar ? `/static/uploads/${avatar}` : "/static/img/default.jpg";
        avatarImg.className = "avatar";
        messageElement.appendChild(avatarImg);

        // Thêm nội dung tin nhắn
        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        const usernameDiv = document.createElement("div");
        usernameDiv.className = "message-username";
        usernameDiv.textContent = username;
        contentDiv.appendChild(usernameDiv);

        const messageText = document.createElement("div");
        messageText.textContent = message;
        contentDiv.appendChild(messageText);

        messageElement.appendChild(contentDiv);

        // Thêm vào danh sách tin nhắn
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Gửi tin nhắn đến AI
    sendButtonAI.addEventListener("click", (e) => {
        e.preventDefault();
        const message = messageInputAI.value.trim();
        if (message) {
            socket.emit("send_message_ai", { message });
            addMessageAI(" You ", message, "sent");
            messageInputAI.value = "";
        }
    });

    // Nhận tin nhắn từ AI
    socket.on("new_message_ai", (data) => {
        addMessageAI("Chat Bot", data.message, "received");
    });

    // Hàm thêm tin nhắn vào khung chat AI
    function addMessageAI(username, message, type) {
        const messageElement = document.createElement("div");
        messageElement.className = "message " + type;

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        const usernameDiv = document.createElement("div");
        usernameDiv.className = "message-username";
        usernameDiv.textContent = username;
        contentDiv.appendChild(usernameDiv);

        const messageText = document.createElement("div");
        messageText.textContent = message;
        contentDiv.appendChild(messageText);

        messageElement.appendChild(contentDiv);

        chatMessagesAI.appendChild(messageElement);
        chatMessagesAI.scrollTop = chatMessagesAI.scrollHeight;
    }
</script>

{% endblock %}