{% extends "base.html" %}

{% block title %}Dịch Văn Bản{% endblock %}

{% block extra_css %}
<style>
    .translator-container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .translator-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .translator-header h2 {
        font-weight: 600;
        margin-bottom: 0;
    }
    
    .language-selector {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .textarea-container {
        position: relative;
        margin-bottom: 15px;
    }
    
    .textarea-container textarea {
        resize: none;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        min-height: 150px;
    }
    
    .textarea-container .character-count {
        position: absolute;
        bottom: 15px;
        right: 15px;
        font-size: 12px;
        color: #888;
    }
    
    .textarea-container .clear-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
    }
    
    .translator-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
    }
    
    .translator-actions button {
        border-radius: 50px;
        padding: 8px 16px;
    }
    
    .history-container {
        margin-top: 30px;
    }
    
    .history-item {
        background-color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 0.1rem 0.5rem rgba(0, 0, 0, 0.05);
    }
    
    .history-item .history-meta {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #888;
        margin-bottom: 10px;
    }
    
    .history-item .history-text {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .history-item .history-text .text-item {
        padding: 10px;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    
    .history-item .history-text .text-translated {
        background-color: #e8f4ff;
    }
    
    .swap-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: var(--primary-color);
        transition: transform 0.3s ease;
    }
    
    .swap-btn:hover {
        transform: rotate(180deg);
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        margin: 10px 0;
    }

    .file-upload-container {
        margin-top: 15px;
        padding: 15px;
        border: 2px dashed #ddd;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s ease;
    }
    
    .file-upload-container:hover {
        border-color: var(--primary-color);
    }
    
    .file-upload-container i {
        font-size: 24px;
        color: #888;
        margin-bottom: 5px;
    }
    
    .file-upload-container p {
        margin-bottom: 0;
        color: #666;
    }
    
    #file-input {
        display: none;
    }
    
    .selected-file {
        display: none;
        margin-top: 10px;
        padding: 8px 15px;
        background-color: #f0f0f0;
        border-radius: 5px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="translator-container">
        <div class="translator-header">
            <h2>Công Cụ Dịch Thuật</h2>
        </div>
        
        <div class="language-selector">
            <select id="source-language" class="form-select">
                <option value="" disabled selected>Chọn ngôn ngữ nguồn</option>
                {% for code, name in languages.items() %}
                <option value="{{ code }}">{{ name|capitalize }}</option>
                {% endfor %}
            </select>
            
            <button id="swap-languages" class="swap-btn">
                <i class="fas fa-exchange-alt"></i>
            </button>
            
            <select id="target-language" class="form-select">
                <option value="" disabled selected>Chọn ngôn ngữ đích</option>
                {% for code, name in languages.items() %}
                <option value="{{ code }}" {% if code == 'vi' %}selected{% endif %}>{{ name|capitalize }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="textarea-container">
                    <textarea id="source-text" class="form-control" placeholder="Nhập văn bản cần dịch..."></textarea>
                    <button class="clear-btn" id="clear-source">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="character-count">0/5000</div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="textarea-container">
                    <textarea id="target-text" class="form-control" placeholder="Bản dịch sẽ hiển thị ở đây..." readonly></textarea>
                    <button class="clear-btn" id="copy-target">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="loading-spinner" id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang dịch...</span>
            </div>
            <p class="mt-2">Đang dịch...</p>
        </div>
        
        <div class="translator-actions">
            <button id="translate-btn" class="btn btn-primary">
                <i class="fas fa-language me-2"></i>Dịch Ngay
            </button>
            
            <div class="btn-group">
                <button class="btn btn-outline-secondary" id="file-upload-btn">
                    <i class="fas fa-file-upload me-2"></i>Tải lên tệp
                </button>
            </div>
        </div>
        
        <div class="file-upload-container" id="file-upload-area">
            <input type="file" id="file-input" accept=".txt,.doc,.docx,.pdf">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Kéo và thả tệp văn bản hoặc nhấp để chọn</p>
            <small>Hỗ trợ .txt, .doc, .docx, .pdf (tối đa 5MB)</small>
        </div>
        
        <div class="selected-file" id="selected-file">
            <span id="file-name"></span>
            <button class="btn btn-sm btn-outline-danger ms-2" id="remove-file">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    {% if history and history|length > 0 %}
    <div class="history-container">
        <h3 class="mb-4">Lịch Sử Dịch</h3>
        
        {% for item in history %}
        <div class="history-item">
            <div class="history-meta">
                <span>{{ item.timestamp }}</span>
                <span>{{ languages[item.source_lang]|capitalize }} → {{ languages[item.target_lang]|capitalize }}</span>
            </div>
            <div class="history-text">
                <div class="text-item">{{ item.text }}</div>
                <div class="text-item text-translated">{{ item.translated }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceText = document.getElementById('source-text');
    const targetText = document.getElementById('target-text');
    const sourceLanguage = document.getElementById('source-language');
    const targetLanguage = document.getElementById('target-language');
    const translateBtn = document.getElementById('translate-btn');
    const clearSourceBtn = document.getElementById('clear-source');
    const copyTargetBtn = document.getElementById('copy-target');
    const swapLanguagesBtn = document.getElementById('swap-languages');
    const characterCount = document.querySelector('.character-count');
    const loadingSpinner = document.getElementById('loading-spinner');
    const fileInput = document.getElementById('file-input');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const fileUploadArea = document.getElementById('file-upload-area');
    const selectedFile = document.getElementById('selected-file');
    const fileName = document.getElementById('file-name');
    const removeFileBtn = document.getElementById('remove-file');
    
    // Set initial values
    sourceLanguage.value = 'en';
    targetLanguage.value = 'vi';
    
    // Character count update
    sourceText.addEventListener('input', function() {
        const length = this.value.length;
        characterCount.textContent = `${length}/5000`;
        
        if (length > 5000) {
            characterCount.style.color = 'red';
        } else {
            characterCount.style.color = '#888';
        }
    });
    
    // Clear source text
    clearSourceBtn.addEventListener('click', function() {
        sourceText.value = '';
        characterCount.textContent = '0/5000';
    });
    
    // Copy translated text
    copyTargetBtn.addEventListener('click', function() {
        if (targetText.value) {
            targetText.select();
            document.execCommand('copy');
            
            // Show copied notification
            const originalIcon = copyTargetBtn.innerHTML;
            copyTargetBtn.innerHTML = '<i class="fas fa-check"></i>';
            
            setTimeout(() => {
                copyTargetBtn.innerHTML = originalIcon;
            }, 2000);
        }
    });
    
    // Swap languages
    swapLanguagesBtn.addEventListener('click', function() {
        const sourceValue = sourceLanguage.value;
        const targetValue = targetLanguage.value;
        
        if (sourceValue && targetValue) {
            sourceLanguage.value = targetValue;
            targetLanguage.value = sourceValue;
            
            // Also swap text if both fields have content
            if (sourceText.value && targetText.value) {
                const temp = sourceText.value;
                sourceText.value = targetText.value;
                targetText.value = temp;
                
                // Update character count
                characterCount.textContent = `${sourceText.value.length}/5000`;
            }
        }
    });
    
    // Translate button click
    translateBtn.addEventListener('click', function() {
        if (!sourceText.value.trim()) {
            alert('Vui lòng nhập văn bản cần dịch.');
            return;
        }
        
        if (!sourceLanguage.value) {
            alert('Vui lòng chọn ngôn ngữ nguồn.');
            return;
        }
        
        if (!targetLanguage.value) {
            alert('Vui lòng chọn ngôn ngữ đích.');
            return;
        }
        
        if (sourceText.value.length > 5000) {
            alert('Văn bản quá dài. Vui lòng giữ dưới 5000 ký tự.');
            return;
        }
        
        // Show loading spinner
        loadingSpinner.style.display = 'block';
        
        // Prepare request data
        const requestData = {
            text: sourceText.value,
            source_lang: sourceLanguage.value,
            target_lang: targetLanguage.value
        };
        
        // Send translation request
        fetch('/translate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            
            if (data.success) {
                targetText.value = data.translated_text;
            } else {
                alert('Lỗi dịch: ' + data.error);
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            alert('Lỗi kết nối: ' + error);
        });
    });
    
    // File upload handling
    fileUploadBtn.addEventListener('click', function() {
        fileInput.click();
    });
    
    fileUploadArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--primary-color)';
    });
    
    fileUploadArea.addEventListener('dragleave', function() {
        this.style.borderColor = '#ddd';
    });
    
    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = '#ddd';
        
        if (e.dataTransfer.files.length) {
            handleFile(e.dataTransfer.files[0]);
        }
    });
    
    fileInput.addEventListener('change', function() {
        if (this.files.length) {
            handleFile(this.files[0]);
        }
    });
    
    removeFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        selectedFile.style.display = 'none';
        fileUploadArea.style.display = 'block';
    });
    
    function handleFile(file) {
        // Check file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            alert('Tệp quá lớn. Vui lòng chọn tệp dưới 5MB.');
            return;
        }
        
        // Check file type
        const allowedTypes = ['text/plain', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/pdf'];
        if (!allowedTypes.includes(file.type)) {
            alert('Định dạng tệp không được hỗ trợ. Vui lòng chọn tệp .txt, .doc, .docx hoặc .pdf.');
            return;
        }
        
        // Display selected file
        fileName.textContent = file.name;
        selectedFile.style.display = 'block';
        fileUploadArea.style.display = 'none';
        
        // If it's a text file, read and display content
        if (file.type === 'text/plain') {
            const reader = new FileReader();
            reader.onload = function(e) {
                sourceText.value = e.target.result;
                characterCount.textContent = `${sourceText.value.length}/5000`;
            };
            reader.readAsText(file);
        } else {
            // For other file types, prepare to upload
            if (!sourceLanguage.value) {
                alert('Vui lòng chọn ngôn ngữ nguồn.');
                return;
            }
            
            if (!targetLanguage.value) {
                alert('Vui lòng chọn ngôn ngữ đích.');
                return;
            }
            
            // Show loading spinner
            loadingSpinner.style.display = 'block';
            
            // Prepare form data for file upload
            const formData = new FormData();
            formData.append('file', file);
            formData.append('source_lang', sourceLanguage.value);
            formData.append('target_lang', targetLanguage.value);
            
            // Send file for translation
            fetch('/translate/file', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    targetText.value = data.translated_text;
                    
                    // Also set source text if possible
                    if (data.source_text) {
                        sourceText.value = data.source_text;
                        characterCount.textContent = `${sourceText.value.length}/5000`;
                    }
                } else {
                    alert('Lỗi dịch tệp: ' + data.error);
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                alert('Lỗi kết nối: ' + error);
            });
        }
    }
    
    // Auto-translate as you type (with debounce)
    let typingTimer;
    const doneTypingInterval = 1000; // 1 second
    
    sourceText.addEventListener('keyup', function() {
        clearTimeout(typingTimer);
        
        if (this.value) {
            typingTimer = setTimeout(autoTranslate, doneTypingInterval);
        }
    });
    
    sourceText.addEventListener('keydown', function() {
        clearTimeout(typingTimer);
    });
    
    function autoTranslate() {
        if (sourceText.value.trim() && sourceLanguage.value && targetLanguage.value) {
            // Only auto-translate if text is less than 1000 chars to avoid rate limiting
            if (sourceText.value.length <= 1000) {
                translateBtn.click();
            }
        }
    }
});
</script>
{% endblock %} 