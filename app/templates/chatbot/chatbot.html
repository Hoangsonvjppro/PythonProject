{% extends "base.html" %}

{% block title %}Chatbot{% endblock %}

{% block content %}
<div class="container py-4">
    <h2>Chatbot</h2>
    <div id="full-chat-box" class="card">
        <div id="full-chat-header" class="card-header bg-primary text-white">
            Chat với SpeakEasy Bot
        </div>
        <div id="full-chat-body" class="card-body" style="height: 400px; overflow-y: auto;">
        </div>
        <div id="full-chat-footer" class="card-footer">
            <div class="input-group">
                <input type="text" id="full-chat-input" class="form-control" placeholder="Nhập tin nhắn...">
                <button id="full-chat-send" class="btn btn-primary">Gửi</button>
            </div>
        </div>
    </div>
</div>

<script>
    const currentUser = "{{ current_user.username if current_user.is_authenticated else 'Guest' }}";
document.addEventListener('DOMContentLoaded', function () {
    const socket = io.connect('http://' + document.domain + ':' + location.port);
    const fullChatBody = document.getElementById('full-chat-body');
    const fullChatInput = document.getElementById('full-chat-input');
    const fullChatSend = document.getElementById('full-chat-send');

    function addFullChatMessage(username, message, type) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        messageElement.innerHTML = `
            <div class="message-content">
                <div class="message-username">${username}</div>
                <div>${message}</div>
            </div>`;
        fullChatBody.appendChild(messageElement);
        fullChatBody.scrollTop = fullChatBody.scrollHeight;
    }

    fullChatSend.addEventListener('click', () => {
        const message = fullChatInput.value.trim();
        if (!message) {
            addFullChatMessage('System', 'Tin nhắn không được để trống.', 'received');
            return;
        }
        addFullChatMessage(currentUser, message, 'sent');
        addFullChatMessage('Chat Bot', '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...', 'received');
        socket.emit('send_message_chatbot', { message });
        fullChatInput.value = '';
    });

    fullChatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            fullChatSend.click();
        }
    });

    socket.on('new_message_chatbot', (data) => {
        const lastMessage = fullChatBody.lastElementChild;
        if (lastMessage && lastMessage.textContent.includes('Đang xử lý...')) {
            lastMessage.remove();
        }
        addFullChatMessage('Chat Bot', data.message, 'received');
    });
});
</script>

<style>
.message {
    display: flex;
    align-items: flex-start;
    margin: 6px 0;
    max-width: 75%;
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 14px;
}
.received {
    background: #e9ecef;
    align-self: flex-start;
}
.sent {
    background: #007bff;
    color: white;
    align-self: flex-end;
    margin-left: auto;
}
.message-content {
    display: flex;
    flex-direction: column;
}
.message-username {
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 4px;
}
</style>
{% endblock %} 